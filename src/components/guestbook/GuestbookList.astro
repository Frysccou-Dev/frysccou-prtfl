---
import turso from "../../lib/turso";
import { translations } from "../../i18n/translations.js";

interface GuestbookEntry {
  id: number;
  author: string;
  message: string;
  created_at: string;
}

let entries: GuestbookEntry[] = [];

try {
  const result = await turso.execute(
    "SELECT id, author, message, created_at FROM guestbook ORDER BY created_at DESC LIMIT 50",
  );
  entries = result.rows as unknown as GuestbookEntry[];
} catch (e) {
  console.error("Error loading guestbook:", e);
}

const formatDate = (dateStr: string) => {
  // Ensure UTC parsing
  const cleanDate = dateStr.endsWith("Z")
    ? dateStr
    : dateStr.replace(" ", "T") + "Z";
  const date = new Date(cleanDate);
  const now = new Date();
  const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);

  if (diffInSeconds < 60) return "Just now";
  if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
  if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;

  return new Intl.RelativeTimeFormat("en", { numeric: "auto" }).format(
    -Math.floor(diffInSeconds / 86400),
    "day",
  );
};
const t = translations.en;
---

<div class="space-y-4 max-h-150 overflow-y-auto pr-2 custom-scrollbar">
  {
    entries.length === 0 ? (
      <div class="text-center py-12">
        <p class="text-text-muted text-sm" data-i18n="guestbook.noMessages">
          {t.guestbook.noMessages}
        </p>
        <p
          class="text-accent text-xs font-bold mt-1"
          data-i18n="guestbook.beFirst"
        >
          {t.guestbook.beFirst}
        </p>
      </div>
    ) : (
      entries.map((entry) => (
        <div class="guestbook-entry opacity-0 translate-y-4 group p-px rounded-2xl bg-linear-to-r from-accent/10 to-rose-accent/10 hover:from-accent/20 hover:to-rose-accent/20 transition-all duration-500">
          <div class="bg-white/80 backdrop-blur-sm rounded-[calc(1rem-1px)] p-4 border border-white hover:border-accent/20 transition-all duration-500">
            <div class="flex items-start justify-between gap-4 mb-2">
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-accent-soft/30 flex items-center justify-center border border-accent/20">
                  <span class="text-accent font-bold text-sm">
                    {entry.author.charAt(0).toUpperCase()}
                  </span>
                </div>
                <div>
                  <h4 class="text-sm font-bold text-text-primary">
                    {entry.author}
                  </h4>
                  <time class="text-[10px] text-text-muted">
                    {formatDate(entry.created_at)}
                  </time>
                </div>
              </div>
            </div>
            <p class="text-sm text-text-secondary leading-relaxed pl-10">
              {entry.message}
            </p>
          </div>
        </div>
      ))
    )
  }
</div>

<style>
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
  }

  .custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: rgba(196, 181, 253, 0.3);
    border-radius: 3px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: rgba(196, 181, 253, 0.5);
  }
</style>

<script>
  import gsap from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  document.addEventListener("DOMContentLoaded", () => {
    const entries = document.querySelectorAll(".guestbook-entry");

    entries.forEach((entry, index) => {
      gsap.to(entry, {
        opacity: 1,
        y: 0,
        duration: 0.6,
        delay: index * 0.1,
        ease: "power2.out",
      });
    });
  });
</script>
