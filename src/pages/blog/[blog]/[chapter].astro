---
import Layout from "../../../presentation/layouts/Layout.astro";
import ScrollReveal from "../../../presentation/components/ui/ScrollReveal";
import { getCollection } from "astro:content";
import { ArrowLeft, ArrowRight, Home } from "lucide-react";

export async function getStaticPaths() {
  const allPosts = await getCollection("blog");
  return allPosts.map((post) => {
    const p = post.slug.split("/");
    return {
      params: { blog: p[0], chapter: p[1] },
      props: { post },
    };
  });
}

const { post } = Astro.props;
const { blog } = Astro.params;
const { Content } = await post.render();

const allPosts = await getCollection("blog");
const chapters = allPosts
  .filter((p) => p.slug.startsWith(blog as string))
  .sort((a, b) => a.data.order - b.data.order);

const idx = chapters.findIndex((p) => p.id === post.id);
const prev = idx > 0 ? chapters[idx - 1] : null;
const next = idx < chapters.length - 1 ? chapters[idx + 1] : null;
---

<Layout title={`${post.data.chapterTitle} | ${post.data.blogTitle}`}>
  <article class="pt-64 pb-40">
    <div class="max-w-4xl mx-auto px-6">
      <ScrollReveal client:load>
        <div class="mb-24">
          <div class="flex items-center gap-4 mb-12">
            <a
              href={`/blog/${blog}`}
              class="w-12 h-12 flex items-center justify-center rounded-full border border-white/10 text-surface-400 hover:border-primary hover:text-primary transition-all"
            >
              <ArrowLeft size={20} />
            </a>
            <span
              class="text-[10px] font-black uppercase tracking-[0.2em] text-surface-500"
              >Series: {post.data.blogTitle}</span
            >
          </div>

          <h1
            class="text-5xl md:text-8xl font-display font-black uppercase tracking-tighter mb-8"
          >
            {post.data.chapterTitle}
          </h1>
          <p
            class="text-2xl text-surface-400 font-light italic leading-relaxed"
          >
            {post.data.description}
          </p>
        </div>

        <div class="prose prose-invert prose-emerald max-w-none">
          <Content />
        </div>

        <div
          class="mt-40 pt-20 border-t border-white/5 flex flex-col md:flex-row items-center justify-between gap-12"
        >
          {
            prev ? (
              <a href={`/blog/${prev.slug}`} class="flex flex-col gap-4 group">
                <span class="text-[10px] font-black uppercase tracking-widest text-surface-500">
                  Back
                </span>
                <div class="flex items-center gap-4 text-2xl font-display font-bold group-hover:text-primary transition-colors">
                  <ArrowLeft size={24} />
                  {prev.data.chapterTitle}
                </div>
              </a>
            ) : (
              <div />
            )
          }

          <a
            href={`/blog/${blog}`}
            class="w-16 h-16 flex items-center justify-center rounded-full bg-surface-900 border border-white/5 hover:border-primary/50 transition-all"
          >
            <Home size={20} class="text-surface-400" />
          </a>

          {
            next ? (
              <a
                href={`/blog/${next.slug}`}
                class="flex flex-col items-end gap-4 group text-right"
              >
                <span class="text-[10px] font-black uppercase tracking-widest text-surface-500">
                  Next
                </span>
                <div class="flex items-center gap-4 text-2xl font-display font-bold group-hover:text-primary transition-colors">
                  {next.data.chapterTitle}
                  <ArrowRight size={24} />
                </div>
              </a>
            ) : (
              <div />
            )
          }
        </div>
      </ScrollReveal>
    </div>
  </article>
</Layout>
